<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radial Menu Playground</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 100vw;
      height: 100vh;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, -apple-system, sans-serif;
      overflow: hidden;
      touch-action: none;
      user-select: none;
    }

    #canvas {
      position: relative;
      width: 100%;
      height: 100%;
      cursor: grab;
    }

    #canvas:active {
      cursor: grabbing;
    }

    .token {
      position: absolute;
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.15s;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .token:hover {
      transform: translate(-50%, -50%) scale(1.05);
    }

    .token:active {
      transform: translate(-50%, -50%) scale(0.95);
    }

    .radial-menu {
      position: absolute;
      pointer-events: none;
      z-index: 100;
    }

    .radial-bg {
      fill: rgba(0, 0, 0, 0.85);
      stroke: rgba(255, 255, 255, 0.3);
      stroke-width: 2;
    }

    .radial-center {
      fill: rgba(60, 60, 60, 0.9);
      stroke: rgba(255, 255, 255, 0.5);
      stroke-width: 1.5;
    }

    .segment-highlight {
      fill: rgba(57, 255, 20, 0.3);
      stroke: rgba(57, 255, 20, 0.8);
      stroke-width: 2;
    }

    .segment-icon {
      fill: white;
      font-size: 24px;
      font-weight: bold;
      user-select: none;
      pointer-events: none;
    }

    .segment-icon.active {
      fill: #39ff14;
    }

    .segment-label {
      fill: rgba(255, 255, 255, 0.8);
      font-size: 11px;
      user-select: none;
      pointer-events: none;
    }

    .segment-label.active {
      fill: #39ff14;
      font-weight: bold;
    }

    .drag-line {
      stroke: rgba(57, 255, 20, 0.6);
      stroke-width: 2;
      stroke-linecap: round;
    }

    .debug-info {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px;
      border-radius: 8px;
      font-size: 12px;
      font-family: monospace;
      line-height: 1.6;
    }

    .instruction {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      max-width: 250px;
    }

    .instruction h3 {
      margin-bottom: 10px;
      color: #667eea;
    }
  </style>
</head>
<body>
  <div id="canvas">
    <div class="token">OH2</div>
  </div>

  <div class="debug-info">
    <div>Mode: <span id="mode">Idle</span></div>
    <div>Position: <span id="position">-</span></div>
    <div>Active Segment: <span id="segment">None</span></div>
    <div>Timer: <span id="timer">-</span></div>
  </div>

  <div class="instruction">
    <h3>How to Use</h3>
    <p><strong>Click and hold</strong> the token for 250ms to open the radial menu.</p>
    <p><strong>Drag</strong> to select a segment (‚Üë Draw, ‚Üí Assign, ‚Üì Highlight, ‚Üê Tags).</p>
    <p><strong>Release</strong> to execute the action.</p>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const token = document.querySelector('.token');
    const debugMode = document.getElementById('mode');
    const debugPosition = document.getElementById('position');
    const debugSegment = document.getElementById('segment');
    const debugTimer = document.getElementById('timer');

    let holdTimer = null;
    let menuOpen = false;
    let menuElement = null;
    let startX = 0;
    let startY = 0;
    let currentAngle = null;

    const HOLD_DURATION = 250; // ms
    const MENU_RADIUS = 70;
    const INNER_RADIUS = 20;

    const segments = [
      { id: 'draw', angle: Math.PI / 2, icon: '‚Üë', label: 'Draw Path' },
      { id: 'assign', angle: 0, icon: 'üë§', label: 'Assign' },
      { id: 'highlight', angle: -Math.PI / 2, icon: '‚òÖ', label: 'Highlight' },
      { id: 'tags', angle: Math.PI, icon: 'üè∑', label: 'Tags' }
    ];

    function getActiveSegment(angle) {
      if (angle === null) return null;

      // Normalize to 0-2œÄ
      const normalized = ((angle % (Math.PI * 2)) + Math.PI * 2) % (Math.PI * 2);

      // Right (‚Üí): -45¬∞ to 45¬∞
      if (normalized >= Math.PI * 7/4 || normalized < Math.PI / 4) return 'assign';
      // Up (‚Üë): 45¬∞ to 135¬∞
      if (normalized >= Math.PI / 4 && normalized < Math.PI * 3/4) return 'draw';
      // Left (‚Üê): 135¬∞ to 225¬∞
      if (normalized >= Math.PI * 3/4 && normalized < Math.PI * 5/4) return 'tags';
      // Down (‚Üì): 225¬∞ to 315¬∞
      if (normalized >= Math.PI * 5/4 && normalized < Math.PI * 7/4) return 'highlight';

      return null;
    }

    function createRadialMenu(x, y) {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.classList.add('radial-menu');
      svg.style.left = '0';
      svg.style.top = '0';
      svg.style.width = '100%';
      svg.style.height = '100%';
      svg.style.position = 'fixed';

      // Background circle
      const bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      bgCircle.classList.add('radial-bg');
      bgCircle.setAttribute('cx', x);
      bgCircle.setAttribute('cy', y);
      bgCircle.setAttribute('r', MENU_RADIUS);
      svg.appendChild(bgCircle);

      // Center circle (cancel zone)
      const centerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      centerCircle.classList.add('radial-center');
      centerCircle.setAttribute('cx', x);
      centerCircle.setAttribute('cy', y);
      centerCircle.setAttribute('r', INNER_RADIUS);
      svg.appendChild(centerCircle);

      // Segments
      segments.forEach(seg => {
        const labelRadius = MENU_RADIUS * 0.65;
        const iconX = x + Math.cos(seg.angle) * labelRadius;
        const iconY = y - Math.sin(seg.angle) * labelRadius;

        // Highlight circle (initially hidden)
        const highlight = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        highlight.classList.add('segment-highlight');
        highlight.setAttribute('cx', iconX);
        highlight.setAttribute('cy', iconY);
        highlight.setAttribute('r', 30);
        highlight.setAttribute('data-segment', seg.id);
        highlight.style.display = 'none';
        svg.appendChild(highlight);

        // Icon
        const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        icon.classList.add('segment-icon');
        icon.setAttribute('x', iconX);
        icon.setAttribute('y', iconY);
        icon.setAttribute('text-anchor', 'middle');
        icon.setAttribute('dominant-baseline', 'middle');
        icon.setAttribute('data-segment', seg.id);
        icon.textContent = seg.icon;
        svg.appendChild(icon);

        // Label
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.classList.add('segment-label');
        label.setAttribute('x', iconX);
        label.setAttribute('y', iconY + 20);
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('dominant-baseline', 'middle');
        label.setAttribute('data-segment', seg.id);
        label.textContent = seg.label;
        svg.appendChild(label);
      });

      // Drag indicator line
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.classList.add('drag-line');
      line.setAttribute('x1', x);
      line.setAttribute('y1', y);
      line.setAttribute('x2', x);
      line.setAttribute('y2', y);
      line.style.display = 'none';
      svg.appendChild(line);

      document.body.appendChild(svg);
      return svg;
    }

    function updateRadialMenu(angle) {
      if (!menuElement) return;

      const activeSegmentId = getActiveSegment(angle);
      debugSegment.textContent = activeSegmentId || 'None';

      // Update highlights
      menuElement.querySelectorAll('.segment-highlight').forEach(el => {
        el.style.display = el.dataset.segment === activeSegmentId ? 'block' : 'none';
      });

      // Update icon/label colors
      menuElement.querySelectorAll('.segment-icon, .segment-label').forEach(el => {
        if (el.dataset.segment === activeSegmentId) {
          el.classList.add('active');
        } else {
          el.classList.remove('active');
        }
      });

      // Update drag line
      if (angle !== null) {
        const line = menuElement.querySelector('.drag-line');
        const endX = startX + Math.cos(angle) * MENU_RADIUS * 0.8;
        const endY = startY - Math.sin(angle) * MENU_RADIUS * 0.8;
        line.setAttribute('x2', endX);
        line.setAttribute('y2', endY);
        line.style.display = 'block';
      }
    }

    function closeRadialMenu() {
      if (menuElement) {
        menuElement.remove();
        menuElement = null;
      }
      menuOpen = false;
      debugMode.textContent = 'Idle';
    }

    // Mouse/Touch handlers
    token.addEventListener('mousedown', (e) => {
      e.preventDefault();
      startX = e.clientX;
      startY = e.clientY;
      currentAngle = null;

      debugMode.textContent = 'Holding...';
      debugPosition.textContent = `${startX}, ${startY}`;
      debugTimer.textContent = '0ms';

      const startTime = Date.now();
      const timerInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        debugTimer.textContent = `${elapsed}ms`;
      }, 10);

      holdTimer = setTimeout(() => {
        clearInterval(timerInterval);
        debugTimer.textContent = `${HOLD_DURATION}ms (opened)`;
        menuOpen = true;
        debugMode.textContent = 'Menu Open';

        // Vibrate if supported
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }

        // Create menu at touch position
        menuElement = createRadialMenu(startX, startY);
      }, HOLD_DURATION);
    });

    document.addEventListener('mousemove', (e) => {
      if (!menuOpen) return;

      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      const distance = Math.sqrt(dx * dx + dy * dy);

      if (distance > 5) {
        currentAngle = Math.atan2(startY - e.clientY, e.clientX - startX);
        updateRadialMenu(currentAngle);
        debugPosition.textContent = `${e.clientX}, ${e.clientY} (angle: ${(currentAngle * 180 / Math.PI).toFixed(0)}¬∞)`;
      } else {
        currentAngle = null;
        updateRadialMenu(null);
      }
    });

    document.addEventListener('mouseup', () => {
      if (holdTimer) {
        clearTimeout(holdTimer);
        holdTimer = null;
      }

      if (menuOpen) {
        const activeSegmentId = getActiveSegment(currentAngle);
        if (activeSegmentId) {
          console.log('Executed:', activeSegmentId);
          alert(`Executed: ${activeSegmentId}`);
        }
        closeRadialMenu();
      }

      debugMode.textContent = 'Idle';
      debugTimer.textContent = '-';
    });

    // Touch support
    token.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      token.dispatchEvent(mouseEvent);
    });

    document.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      document.dispatchEvent(mouseEvent);
    }, { passive: false });

    document.addEventListener('touchend', (e) => {
      e.preventDefault();
      const mouseEvent = new MouseEvent('mouseup');
      document.dispatchEvent(mouseEvent);
    });
  </script>
</body>
</html>
